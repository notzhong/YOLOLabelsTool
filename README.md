# YOLO Label Tool

基于 PySide6 的 YOLO 标注和训练工具，支持手动标注、模型辅助标注和模型训练功能。

## 功能特点

### 🎯 核心功能
- **图片管理**：加载文件夹、图片预览、切换图片
- **标注绘制**：手动绘制矩形标注框、编辑标注框、删除标注
- **类别管理**：添加/编辑/删除标注类别、自定义类别颜色
- **数据导出**：导出YOLO格式数据集（data.yaml + labels文件夹）

### 🚀 高级功能
- **模型辅助标注**：加载训练好的YOLO模型进行自动标注
- **模型参数调整**：实时调整置信度阈值、IoU阈值
- **数据集划分**：自动划分训练集/验证集/测试集
- **模型训练**：完整的YOLO模型训练功能，支持多种训练参数配置
- **国际化支持**：中英文双语界面，支持动态语言切换
- **快捷键支持**：提高标注效率
- **标注统计**：各类别标注数量统计

### 🎨 用户体验
- **双主题切换**：支持黑夜/白天主题，保护眼睛
- **图片缩放**：支持放大/缩小/适应窗口、鼠标滚轮缩放
- **快捷键**：常用操作快捷键支持
- **状态显示**：实时显示标注状态和信息
- **撤销/重做**：支持标注操作的撤销和重做
- **日志系统**：自动记录程序运行日志和异常信息，方便调试

### 🔧 开发增强
- **异常捕获**：自动捕获未处理异常并记录到日志文件
- **模块化设计**：代码结构清晰，易于扩展和维护
- **配置文件**：保存用户偏好设置，如窗口大小、主题、类别
- **国际化架构**：支持多语言，易于扩展新语言

## 安装要求

### 环境要求
- Python 3.8+
- PySide6
- OpenCV
- ultralytics (YOLO模型支持和训练)

### 安装步骤

1. **克隆仓库**
```bash
git clone <repository-url>
cd YoloLabelTool
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **运行应用**
```bash
python main.py
```

## 快速开始

### 1. 启动应用
```bash
python main.py
```

### 2. 加载图片
- 点击"加载文件夹"按钮选择包含图片的文件夹
- 支持的图片格式：jpg, jpeg, png, bmp, tiff, gif

### 3. 标注图片
1. **选择类别**：在右侧面板选择要标注的类别
2. **绘制标注框**：在图片上按住鼠标左键拖拽绘制矩形框
3. **编辑标注**：可以调整、删除已绘制的标注框

### 4. 导出数据
1. **保存标注**：标注会自动保存到本地
2. **导出YOLO格式**：点击"导出YOLO格式"按钮选择输出目录
3. **数据集划分**：支持自动划分训练集/验证集/测试集

### 5. 模型训练
1. **准备数据集**：使用本工具标注并导出YOLO格式数据集
2. **配置训练**：通过菜单"模型 → 训练模型"打开训练配置对话框
3. **开始训练**：配置参数后点击"开始训练"按钮

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| Ctrl+O | 打开文件夹 |
| Ctrl+S | 保存标注 |
| Ctrl+E | 导出YOLO格式 |
| Ctrl+Z | 撤销 |
| Ctrl+Y | 重做 |
| Delete | 删除选中标注 |
| A / ← | 上一张图片 |
| D / → | 下一张图片 |
| Ctrl+F | 适应窗口 |
| Ctrl++ | 放大 |
| Ctrl+- | 缩小 |
| Ctrl+A | 自动标注当前图片 |
| Ctrl+Shift+A | 批量自动标注 |
| Ctrl+M | 加载模型 |
| Ctrl+T | 训练模型 |

## 标注格式

### YOLO格式
导出文件结构：
```
output/
├── images/
│   ├── train/      # 训练集图片
│   ├── val/        # 验证集图片
│   └── test/       # 测试集图片
├── labels/
│   ├── train/      # 训练集标注（txt格式）
│   ├── val/        # 验证集标注
│   └── test/       # 测试集标注
├── train.txt       # 训练集图片路径列表
├── val.txt         # 验证集图片路径列表
├── test.txt        # 测试集图片路径列表
└── data.yaml       # 数据集配置文件
```

### data.yaml 格式
```yaml
path: ./output
train: images/train
val: images/val
test: images/test

nc: 0  # 类别数量（根据实际添加的类别自动计算）
names: []  # 类别名称列表（用户自定义）
```

### 标注文件格式（.txt）
每行一个标注，格式为：
```
<class_id> <x_center> <y_center> <width> <height>
```
所有坐标值都是归一化后的（0-1之间）。

## 模型辅助标注

### 支持模型
项目基于 [ultralytics](https://github.com/ultralytics/ultralytics) 库实现模型加载和推理，支持以下 YOLO 模型版本：

- **YOLOv5** (.pt格式) - 经典版本，支持广泛
- **YOLOv6** (.pt格式) - 高效检测版本
- **YOLOv8** (.pt格式) - 最新主流版本，支持目标检测、实例分割、姿态估计等
- **YOLOv9** (.pt格式) - 2024年发布的先进版本
- **YOLOv10** (.pt格式) - 2024年发布的高效版本
- **YOLOv11** (.pt格式) - 2024年最新版本

> **注意**：`ultralytics` 库会自动适配不同版本的 YOLO 模型，只要模型文件是 `.pt` 格式且使用标准的 Ultralytics 架构，工具就能正确加载和使用。

### 使用方法
1. **加载模型**：
   - 通过菜单"模型 → 加载模型"或工具栏加载YOLO模型
   - 模型信息面板会自动显示（包含置信度/IoU阈值调整控件）
   - 可选择导入模型类别到类别管理器

2. **自动标注**：
   - **单张图片标注**：选择图片后点击"自动标注"或按 `Ctrl+A`
   - **批量自动标注**：选择多张图片后点击"批量自动标注"或按 `Ctrl+Shift+A`
   - **进度显示**：批量标注时显示进度条

3. **模型参数调整**：
   - **置信度阈值**：调整检测结果的置信度要求
     - 范围：0.01 - 1.00
     - 默认值：0.25
     - 滑块 + 数值输入，实时调整
   - **IoU阈值**：调整非极大值抑制的重叠阈值
     - 范围：0.01 - 1.00
     - 默认值：0.45
     - 滑块 + 数值输入，实时调整

4. **模型管理**：
   - **卸载模型**：模型信息面板提供卸载按钮
   - **刷新信息**：重新加载模型信息
   - **状态指示**：绿色"● 已加载"或红色"● 未加载"

### 注意事项
- 需要安装 `ultralytics` 库：`pip install ultralytics`
- 模型首次推理可能需要额外时间下载权重
- 批量标注时可随时取消

## 模型训练功能

### 训练配置
YOLO Label Tool 提供了完整的模型训练功能，支持详细的训练参数配置：

1. **基本设置**：预训练模型、数据集配置、输出目录、恢复训练等
2. **训练参数**：训练轮数、图像尺寸、批量大小、设备选择、早停耐心值等
3. **优化器设置**：优化器选择、初始学习率、学习率调度策略等
4. **数据增强**：Mixup增强、旋转、剪切、透视变换、HSV增强等
5. **高级参数**：权重衰减、动量、学习率预热、损失权重、标签平滑等

### 训练界面
- **训练配置对话框**：五个标签页分别配置不同参数
- **训练进度对话框**：实时显示训练进度、损失曲线、日志输出
- **异步训练**：训练在后台线程中进行，不阻塞主界面
- **进度监控**：实时显示当前epoch、已用时间、损失值

### 市场最优参数
工具提供了经过验证的市场最优默认参数，支持一键重置：

- 优化器：AdamW（适合大多数场景）
- 学习率：0.01（配合余弦退火调度）
- 训练轮数：300（充分训练）
- 图像尺寸：640（平衡精度和速度）
- 批量大小：16（适合大多数GPU）
- 数据增强：综合增强策略（HSV、旋转、剪切等）

## 国际化支持

### 支持语言
- **简体中文** (zh_CN) - 默认语言
- **英文** (en_US) - 国际通用语言

### 语言切换
- 通过菜单"语言 → 中文/英文"切换界面语言
- 支持实时切换，无需重启程序
- 所有UI文本、对话框、按钮、菜单都支持翻译

### 翻译架构
- 基于INI文件的翻译系统
- 支持动态加载和切换
- 易于扩展新语言（只需添加新的翻译文件）

## 项目结构

```
YoloLabelTool/
├── main.py                 # 主程序入口
├── pyproject.toml          # 项目配置和依赖
├── requirements.txt        # 依赖包列表
├── requirements-dev.txt    # 开发依赖
├── README.md              # 项目说明
├── src/
│   ├── core/              # 核心模块
│   │   ├── annotation.py  # 标注数据结构和管理器
│   │   ├── image_manager.py # 图片管理器
│   │   ├── class_manager.py # 类别管理器
│   │   └── model_manager.py # YOLO模型管理器
│   ├── ui/                # 用户界面
│   │   ├── main_window.py # 主窗口
│   │   ├── class_dialog.py # 类别编辑对话框
│   │   ├── train_dialog.py # 训练配置对话框
│   │   └── train_progress_dialog.py # 训练进度对话框
│   └── utils/             # 工具模块
│       ├── i18n.py        # 国际化翻译管理器
│       ├── yolo_exporter.py # YOLO格式导出器
│       ├── dataset_splitter.py # 数据集划分器
│       └── logger.py      # 日志系统模块
├── yolo_tool/             # YOLO训练模块
│   ├── __init__.py
│   └── yolo_train.py     # YOLO模型训练器
├── tests/                 # 测试文件
├── data/                  # 示例数据
├── logs/                  # 日志文件目录
│   └── YYYY-MM-DD.log     # 按日期命名的日志文件
├── config/                # 配置文件目录
│   └── config.ini         # 用户配置设置
├── annotations/           # 标注文件目录
│   └── *.json             # 标注数据文件
├── model/                 # 模型文件目录（可选）
├── qss/                   # 主题样式文件
│   ├── dark_theme.qss     # 黑夜主题样式
│   └── light_theme.qss    # 白天主题样式
├── translations/          # 国际化翻译文件
│   ├── zh_CN.ini          # 简体中文翻译
│   └── en_US.ini          # 英文翻译
└── runs/                  # 训练结果目录（由ultralytics自动创建）
```

## 日志系统

### 功能概述
YOLO Label Tool 集成了强大的日志系统，自动记录程序运行状态、用户操作和异常信息。

### 核心功能
1. **自动日志记录**：
   - 程序启动/关闭时间
   - 用户操作（加载图片、添加标注、导出等）
   - 模型加载和推理状态
   - 训练进度和状态
   - 异常错误和警告信息

2. **异常捕获**：
   - 自动捕获未处理的异常
   - 记录完整的异常追踪信息（包含文件名、行号、调用栈）
   - 支持线程异常捕获

3. **日志文件管理**：
   - 按日期命名：`logs/YYYY-MM-DD.log`
   - 自动创建 logs 目录
   - 包含模块名和行号信息

### 使用方法
- **自动启用**：程序启动时自动启用异常捕获和日志记录
- **查看日志**：打开 `logs/` 目录下的日志文件
- **调试信息**：当程序崩溃或异常时，查看日志文件获取详细信息

### 日志格式示例
```
2026-02-22 19:41:02 - INFO - [__main__] YOLO Label Tool 启动
2026-02-22 19:41:02 - INFO - [__main__] 工作目录: G:\pyCode\YoloLabelTool
2026-02-22 19:41:02 - INFO - [__main__] Python 版本: 3.11.0
2026-02-22 19:41:02 - ERROR - [__main__:176] 函数 faulty_function 发生异常
Traceback (most recent call last):
  File "g:\pyCode\YoloLabelTool\src\utils\logger.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "g:\pyCode\YoloLabelTool\src\utils\logger.py", line 207, in faulty_function
    raise ValueError("这是一个测试异常")
ValueError: 这是一个测试异常
```

## 开发说明

### 添加新功能
1. **扩展标注功能**：修改 `src/core/annotation.py`
2. **修改界面**：修改 `src/ui/main_window.py`
3. **添加导出格式**：在 `src/utils/` 下创建新的导出器
4. **添加训练功能**：修改 `yolo_tool/yolo_train.py` 和 `src/ui/train_dialog.py`
5. **添加新语言支持**：在 `translations/` 目录下添加新的翻译文件
6. **使用日志系统**：通过 `from src.utils.logger import get_logger_simple` 获取日志记录器

### 运行测试
```bash
pytest tests/
```

## 常见问题

### Q: 无法加载图片
A: 检查图片格式是否支持，文件路径是否包含中文或特殊字符

### Q: 导出失败
A: 检查输出目录权限，确保有写入权限

### Q: 模型加载失败
A: 检查模型文件路径是否正确，确保安装了ultralytics库

### Q: 界面显示异常
A: 尝试调整窗口大小，或检查PySide6版本

### Q: 日志文件在哪里？异常信息会保存吗？
A: 日志文件位于 `logs/` 目录下，按日期命名（如 `logs/2026-02-22.log`）。程序异常会自动记录到日志文件中，包含完整的异常追踪信息。

### Q: 标注重做功能点击没反应怎么办？
A: 重做功能需要先执行撤销操作（Ctrl+Z）后才能使用。重做栈为空时按钮会显示为禁用状态。请先撤销一个操作，然后再尝试重做。

### Q: 如何调整模型参数（置信度、IoU阈值）？
A: 加载模型后，在右侧面板的"模型信息"组中，可以使用滑块或数值输入框调整置信度阈值和IoU阈值，调整会实时生效。

### Q: 程序启动时出现"无法访问本地变量'logger'"错误
A: 这是之前版本中的一个bug，已修复。如果遇到此问题，请更新到最新版本，或检查 `main.py` 中的logger变量作用域。

### Q: 训练模型需要什么配置？
A: 训练模型需要足够的GPU内存（建议8GB以上）和充足的数据集。CPU训练也可行，但速度较慢。

### Q: 如何切换界面语言？
A: 通过菜单"语言 → 中文/英文"切换界面语言，切换会立即生效，无需重启程序。

## 贡献指南

1. Fork 本仓库
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交 Issue
- 发送邮件到 developer@example.com

## 更新日志

### v1.2.0 (2026-02-24)
- **新增模型训练功能**：完整的YOLO模型训练支持，包含训练配置对话框和进度监控
- **新增国际化支持**：中英文双语界面，支持动态语言切换
- **新增训练进度对话框**：实时显示训练进度、损失曲线、日志输出
- **新增训练配置对话框**：五个标签页分别配置不同训练参数
- **新增市场最优默认参数**：提供经过验证的训练参数配置
- **增强模型管理**：改进模型信息面板，添加更多状态指示
- **代码优化**：
  - 重构训练模块，支持异步训练
  - 优化翻译管理器，支持动态加载
  - 改进日志系统，添加训练相关日志
- **用户体验改进**：
  - 添加语言切换菜单
  - 添加训练快捷键 (Ctrl+T)
  - 更新快捷键说明文档
  - 完善项目结构文档

### v1.1.0 (2026-02-22)
- **新增日志系统**：自动记录程序运行日志和异常信息
- **增强异常捕获**：全局异常钩子，自动记录未处理异常到日志文件
- **新增双主题支持**：添加白天主题，支持主题切换
- **模型信息面板增强**：
  - 添加置信度阈值调整（滑块+数值输入）
  - 添加IoU阈值调整（滑块+数值输入） 
  - 添加卸载模型按钮
  - 实时显示模型状态
- **代码优化**：
  - 修复 main.py 中的 logger 变量作用域问题
  - 修复 image_manager.py 中 Dict 类型未导入的问题
  - 增强撤销/重做功能的状态提示
- **用户体验改进**：
  - 添加日志文件常见问题说明
  - 完善快捷键说明文档
  - 更新项目结构文档

### v1.0.0 (2026-02-22)
- 初始版本发布
- 支持手动标注
- 支持YOLO格式导出
- 支持模型辅助标注
- 暗色主题界面

---

**开始标注和训练吧！** 🚀